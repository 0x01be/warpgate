<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding favicon -->
    

    <!-- Adding meta -->
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    

    <!-- Adding overlay script-->
    

    <!-- Adding overlay style-->
    


    <title>
      crosshairs.js
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      <div class="navbar-heading" id="navbar-heading"><a href="index.html"><h2 class="navbar-heading-text">Home</h2></a></div><div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><div class="accordion collapsed" id="2141909" > <h3 class="accordion-heading">Classes<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=4563444><div class="accordion-heading child"><a href="Crosshairs.html">Crosshairs</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="Crosshairs.html#.getTag">getTag</a></li><li data-type='method'><a href="Crosshairs.html#_drawControlIcon">_drawControlIcon</a></li><li data-type='method'><a href="Crosshairs.html#_drawRulerText">_drawRulerText</a></li><li data-type='method'><a href="Crosshairs.html#activatePreviewListeners">activatePreviewListeners</a></li><li data-type='method'><a href="Crosshairs.html#draw">draw</a></li><li data-type='method'><a href="Crosshairs.html#drawPreview">drawPreview</a></li><li data-type='method'><a href="Crosshairs.html#refresh">refresh</a></li><li data-type='method'><a href="Crosshairs.html#toObject">toObject</a></li></ul></li><li class="accordion collapsed child" id=8020345><div class="accordion-heading child"><a href="MutationStack.html">MutationStack</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="MutationStack.html#commit">commit</a></li><li data-type='method'><a href="MutationStack.html#deleteAll">deleteAll</a></li><li data-type='method'><a href="MutationStack.html#find">find</a></li><li data-type='method'><a href="MutationStack.html#getName">getName</a></li><li data-type='method'><a href="MutationStack.html#update">update</a></li><li data-type='method'><a href="MutationStack.html#updateAll">updateAll</a></li></ul></li></ul> </div><div class="accordion collapsed" id="7917955" > <h3 class="accordion-heading">Namespaces<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=7018940><div class="accordion-heading child"><a href="warpgate.html">warpgate</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="warpgate.html#.buttonDialog">buttonDialog</a></li><li data-type='method'><a href="warpgate.html#.dismiss">dismiss</a></li><li data-type='method'><a href="warpgate.html#.menu">menu</a></li><li data-type='method'><a href="warpgate.html#.mutate">mutate</a></li><li data-type='method'><a href="warpgate.html#.mutationStack">mutationStack</a></li><li data-type='method'><a href="warpgate.html#.revert">revert</a></li><li data-type='method'><a href="warpgate.html#.spawn">spawn</a></li><li data-type='method'><a href="warpgate.html#.spawnAt">spawnAt</a></li><li data-type='method'><a href="warpgate.html#.wait">wait</a></li></ul></li><li class="accordion-list" id=""><a href="warpgate.abstract.html">abstract</a></li><li class="accordion collapsed child" id=8846972><div class="accordion-heading child"><a href="warpgate.crosshairs.html">crosshairs</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="warpgate.crosshairs.html#.collectPlaceables">collectPlaceables</a></li><li data-type='method'><a href="warpgate.crosshairs.html#.getTag">getTag</a></li><li data-type='method'><a href="warpgate.crosshairs.html#.show">show</a></li></ul></li><li class="accordion collapsed child" id=6707031><div class="accordion-heading child"><a href="warpgate.dnd5e.html">dnd5e</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="warpgate.dnd5e.html#.rollItem">rollItem</a></li></ul></li><li class="accordion collapsed child" id=3328155><div class="accordion-heading child"><a href="warpgate.event.html">event</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="warpgate.event.html#.notify">notify</a></li><li data-type='method'><a href="warpgate.event.html#.remove">remove</a></li><li data-type='method'><a href="warpgate.event.html#.trigger">trigger</a></li><li data-type='method'><a href="warpgate.event.html#.watch">watch</a></li></ul></li><li class="accordion collapsed child" id=5308017><div class="accordion-heading child"><a href="warpgate.plugin.html">plugin</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="warpgate.plugin.html#.queueUpdate">queueUpdate</a></li></ul></li><li class="accordion collapsed child" id=4345304><div class="accordion-heading child"><a href="warpgate.util.html">util</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="warpgate.util.html#.firstGM">firstGM</a></li><li data-type='method'><a href="warpgate.util.html#.firstOwner">firstOwner</a></li><li data-type='method'><a href="warpgate.util.html#.isFirstGM">isFirstGM</a></li><li data-type='method'><a href="warpgate.util.html#.isFirstOwner">isFirstOwner</a></li></ul></li></ul> </div><div class="accordion collapsed" id="4522988" > <h3 class="accordion-heading">Global<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="global.html#ComparisonKeys">ComparisonKeys</a></li><li class="accordion-list" id=""><a href="global.html#CrosshairsConfig">CrosshairsConfig</a></li><li class="accordion-list" id=""><a href="global.html#CrosshairsData">CrosshairsData</a></li><li class="accordion-list" id=""><a href="global.html#MutationData">MutationData</a></li><li class="accordion-list" id=""><a href="global.html#MutationOptions">MutationOptions</a></li><li class="accordion-list" id=""><a href="global.html#ParallelShow">ParallelShow</a></li><li class="accordion-list" id=""><a href="global.html#PostDelta">PostDelta</a></li><li class="accordion-list" id=""><a href="global.html#PostMutate">PostMutate</a></li><li class="accordion-list" id=""><a href="global.html#PostSpawn">PostSpawn</a></li><li class="accordion-list" id=""><a href="global.html#PreSpawn">PreSpawn</a></li><li class="accordion-list" id=""><a href="global.html#Shorthand">Shorthand</a></li><li class="accordion-list" id=""><a href="global.html#SpawningOptions">SpawningOptions</a></li><li class="accordion-list" id=""><a href="global.html#WarpOptions">WarpOptions</a></li><li class="accordion-list" id=""><a href="global.html#WorkflowOptions">WorkflowOptions</a></li></ul> </div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      
      <h1 id='page-title' class="page-title">
        crosshairs.js
      </h1>
      

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* 
 * This file is part of the warpgate module (https://github.com/trioderegion/warpgate)
 * Copyright (c) 2021 Matthew Haentschke.
 * 
 * This program is free software: you can redistribute it and/or modify  
 * it under the terms of the GNU General Public License as published by  
 * the Free Software Foundation, version 3.
 *
 * This program is distributed in the hope that it will be useful, but 
 * WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU 
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License 
 * along with this program. If not, see &lt;http://www.gnu.org/licenses/>.
 */

import { logger } from './logger.js'
import { MODULE } from './module.js'

/** @typedef {import('@league-of-foundry-developers/foundry-vtt-types/src/foundry/common/data/data.mjs/measuredTemplateData.js').MeasuredTemplateDataProperties} MeasuredTemplateProperties */

/**
 * Contains all fields from `MeasuredTemplate#toObject`, plus the following.
 * 
 * @typedef {MeasuredTemplateProperties} CrosshairsData
 * @prop {boolean} cancelled Workflow cancelled via right click (true)
 * @prop {Scene} scene Scene on this crosshairs was last active
 * @prop {number} radius Final radius of template, in pixels
 * @prop {number} size Final diameter of template, in grid units
 */

/**
 * @class
 */
export class Crosshairs extends MeasuredTemplate {

  //constructor(gridSize = 1, data = {}){
  constructor(config, callbacks = {}){
     const templateData = {
      t: "circle",
      user: game.user.id,
      distance: config.size,
      x: config.x,
      y: config.y,
      fillColor: config.fillColor,
      width: 1,
      texture: config.texture,
    }   

    const template = new CONFIG.MeasuredTemplate.documentClass(templateData, {parent: canvas.scene});
    super(template);

    /** @TODO all of these fields should be part of the source data schema for this class **/
    /**  image path to display in the center (under mouse cursor) */
    this.icon = config.icon ?? Crosshairs.ERROR_TEXTURE;

    /** text to display below crosshairs' circle */
    this.label = config.label;

    /** Offsets the default position of the label (in pixels) */
    this.labelOffset = config.labelOffset;

    /**
     * Arbitrary field used to identify this instance
     * of a Crosshairs in the canvas.templates.preview
     * list
     */
    this.tag = config.tag;

    /** Should the center icon be shown? */
    this.drawIcon = config.drawIcon;

    /** Should the outer circle be shown? */
    this.drawOutline = config.drawOutline;

    /** Opacity of the fill color */
    this.fillAlpha = config.fillAlpha;

    /** Should the texture (if any) be tiled
     * or scaled and offset? */
    this.tileTexture = config.tileTexture;

    /** locks the size of crosshairs (shift+scroll) */
    this.lockSize = config.lockSize;

    /** locks the position of crosshairs */
    this.lockPosition = config.lockPosition;

    /** Number of quantization steps along
     * a square's edge (N+1 snap points 
     * along each edge, conting endpoints)
     */
    this.interval = config.interval;

    /** Callback functions to execute
     * at particular times
     */
    this.callbacks = callbacks;

    /** Indicates if the user is actively 
     * placing the crosshairs.
     * Setting this to true in the show
     * callback will stop execution
     * and report the current mouse position
     * as the chosen location
     */
    this.inFlight = false;

    /** indicates if the placement of
     * crosshairs was canceled (with
     * a right click)
     */
    this.cancelled = true;

    /** @type {number} */
    this.radius = (MODULE.isV10 ? this.document.distance : this.data.distance)
      * (MODULE.isV10 ? this.scene.grid.size : this.scene.data.grid);
  }

  /**
   * @returns {CrosshairsData} Current Crosshairs class data
   */
  toObject() {

    /** @type {CrosshairsData} */
    const data = foundry.utils.mergeObject(this.document.toObject(), {
      cancelled: this.cancelled,
      scene: this.scene,
      radius: this.radius,
      size: this.data.distance,
    });

    return data;
  }

  static ERROR_TEXTURE = 'icons/svg/hazard.svg'

  /**
   * Will retrieve the active crosshairs instance with the defined tag identifier.
   * @param {string} key Crosshairs identifier. Will be compared against the Crosshairs `tag` field for strict equality.
   * @returns {PIXI.DisplayObject|undefined}
   */
  static getTag(key) {
    return canvas.templates.preview.children.find( child => child.tag === key )
  }

  static getSnappedPosition({x,y}, interval){
    const offset = interval &lt; 0 ? canvas.grid.size/2 : 0;
    const snapped = canvas.grid.getSnappedPosition(x - offset, y - offset, interval);
    return {x: snapped.x + offset, y: snapped.y + offset};
  }

  /* -----------EXAMPLE CODE FROM MEASUREDTEMPLATE.JS--------- */
  /* Portions of the core package (MeasuredTemplate) repackaged 
   * in accordance with the "Limited License Agreement for Module 
   * Development, found here: https://foundryvtt.com/article/license/ 
   * Changes noted where possible
   */

  /**
   * Set the displayed ruler tooltip text and position
   * @private
   */
    //BEGIN WARPGATE
  _setRulerText() {
    this.ruler.text = this.label;
    /** swap the X and Y to use the default dx/dy of a ray (pointed right)
    //to align the text to the bottom of the template */
    this.ruler.position.set(-this.ruler.width/2 + this.labelOffset.x, this.template.height/2 + 5 + this.labelOffset.y);
    //END WARPGATE
  }

  /** @override */
  async draw() {
    this.clear();

    // Load the texture
    const texture = MODULE.isV10 ? this.texture : this.data.texture;
    if ( texture ) {
      this._texture = await loadTexture(texture, {fallback: 'icons/svg/hazard.svg'});
    } else {
      this._texture = null;
    }

    // Template shape
    this.template = this.addChild(new PIXI.Graphics());

    // Rotation handle
    //BEGIN WARPGATE
    //this.handle = this.addChild(new PIXI.Graphics());
    //END WARPGATE

    // Draw the control icon
    //if(this.drawIcon) 
      this.controlIcon = this.addChild(this._drawControlIcon());

    // Draw the ruler measurement
    this.ruler = this.addChild(this._drawRulerText());

    // Update the shape and highlight grid squares
    this.refresh();
    //BEGIN WARPGATE
    this._setRulerText();
    //this.highlightGrid();
    //END WARPGATE

    // Enable interactivity, only if the Tile has a true ID
    if ( this.id ) this.activateListeners();
    return this;
  }

  /**
   * Draw the Text label used for the MeasuredTemplate
   * @return {PreciseText}
   * @protected
   */
  _drawRulerText() {
    const style = CONFIG.canvasTextStyle.clone();
    style.fontSize = Math.max(Math.round(canvas.dimensions.size * 0.36 * 12) / 12, 36);
    const text = new PreciseText(null, style);
    //BEGIN WARPGATE
    //text.anchor.set(0.5, 0);
    text.anchor.set(0, 0);
    //END WARPGATE
    return text;
  }

  /**
   * Draw the ControlIcon for the MeasuredTemplate
   * @return {ControlIcon}
   * @protected
   */
  _drawControlIcon() {
    const size = Math.max(Math.round((canvas.dimensions.size * 0.5) / 20) * 20, 40);

    //BEGIN WARPGATE
    let icon = new ControlIcon({texture: this.icon, size: size});
    icon.visible = this.drawIcon;
    //END WARPGATE

    icon.pivot.set(size*0.5, size*0.5);
    //icon.x -= (size * 0.5);
    //icon.y -= (size * 0.5);
    icon.angle = MODULE.isV10 ? this.document.direction : this.data.direction;
    return icon;
  }

  /** @override */
  refresh() {
    let d = canvas.dimensions;
    const document = MODULE.isV10 ? this.document : this.data;
    this.position.set(document.x, document.y);

    // Extract and prepare data
    let {direction, distance} = document;
    distance *= (d.size/2);
    //BEGIN WARPGATE
    //width *= (d.size / d.distance);
    //END WARPGATE
    direction = Math.toRadians(direction);

    // Create ray and bounding rectangle
    this.ray = Ray.fromAngle(document.x, document.y, direction, distance);

    // Get the Template shape
    switch ( document.t ) {
      case "circle":
        this.shape = this._getCircleShape(distance);
        break;
      default: logger.error("Non-circular Crosshairs is unsupported!");
    }

    // Draw the Template outline
    this.template.clear()
      .lineStyle(this._borderThickness, this.borderColor, this.drawOutline ? 0.75 : 0)
    //BEGIN WARPGATE
      //.beginFill(/*0x000000, 0.0*/this.fillColor, this.alpha);
    //END WARPGATE


    // Fill Color or Texture

    if ( this._texture ) {
      /* assume 0,0 is top left of texture
       * and scale/offset this texture (due to origin
       * at center of template). tileTexture indicates
       * that this texture is tilable and does not 
       * need to be scaled/offset */
      const scale = this.tileTexture ? 1 : distance * 2 / this._texture.width;
      const offset = this.tileTexture ? 0 : distance;
      this.template.beginTextureFill({
        texture: this._texture,
        matrix: new PIXI.Matrix().scale(scale, scale).translate(-offset,-offset)
      });
    } else { 
      this.template.beginFill(this.fillColor, this.fillAlpha);
    }

    // Draw the shape
    this.template.drawShape(this.shape);

    // Draw origin and destination points
    //BEGIN WARPGATE
    //this.template.lineStyle(this._borderThickness, 0x000000, this.drawOutline ? 0.75 : 0)
    //  .beginFill(0x000000, 0.5)
    //.drawCircle(0, 0, 6)
    //.drawCircle(this.ray.dx, this.ray.dy, 6);
    //END WARPGATE

    // Update visibility
    if (this.drawIcon) {
      this.controlIcon.visible = true;
      this.controlIcon.border.visible = this._hover
      this.controlIcon.angle = document.direction;
    }

    // Draw ruler text
    //BEGIN WARPGATE
    this._setRulerText()
    //END WARPGATE
    return this;
  }
  
   /* END MEASUREDTEMPLATE.JS USAGE */


  /* -----------EXAMPLE CODE FROM ABILITY-TEMPLATE.JS--------- */
  /* Foundry VTT 5th Edition
   * Copyright (C) 2019  Foundry Network
   *
   * This program is free software: you can redistribute it and/or modify
   * it under the terms of the GNU General Public License as published by
   * the Free Software Foundation, either version 3 of the License, or
   * (at your option) any later version.
   *
   * This program is distributed in the hope that it will be useful,
   * but WITHOUT ANY WARRANTY; without even the implied warranty of
   * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   * GNU General Public License for more details.
   *
   * Original License: 
   * https://gitlab.com/foundrynet/dnd5e/-/blob/master/LICENSE.txt
   */

  /**
   * Creates a preview of the spell template
   */
  async drawPreview() {
    // Draw the template and switch to the template layer
    this.initialLayer = canvas.activeLayer;
    this.layer.activate();
    this.draw();
    this.layer.preview.addChild(this);

    // Hide the sheet that originated the preview
    //BEGIN WARPGATE
    this.inFlight = true;
    
    // Activate interactivity
    this.activatePreviewListeners();
    
    // Callbacks
    if (this.callbacks?.show) {
      //await
      this.callbacks.show(this);
      //if (this.inFlight == false) {
      //  this._clearHandlers();
      //}
    }

    /* wait _indefinitely_ for placement to be decided. */
    await MODULE.waitFor( () => !this.inFlight, -1 )
    if (this.activeHandlers) {
      this.clearHandlers();
    }

    //END WARPGATE
    return this;
  }

  /* -------------------------------------------- */

  _mouseMoveHandler(event){
    event.stopPropagation();

    // WARPGATE BEGIN
    /* if our position is locked, do not update it */
    if (this.lockPosition) return;
    // WARPGATE END
    
    // Apply a 20ms throttle
    let now = Date.now(); 
    if ( now - this.moveTime &lt;= 20 ) return;

    const center = event.data.getLocalPosition(this.layer);
    const {x,y} = Crosshairs.getSnappedPosition(center, this.interval);
    if ( MODULE.isV10 ) this.document.updateSource({x, y});
    else this.data.update({x, y});
    this.refresh();
    this.moveTime = now;
  }

  _leftClickHandler(event){
    const document = MODULE.isV10 ? this.document : this.data;
    //const canvasSceneDistance = MODULE.isV10 ? canvas.scene.grid.distance : canvas.scene.data.gridDistance;
    //const thisSceneDistance = MODULE.isV10 ? this.scene.grid.distance : this.scene.data.gridDistance;
    const thisSceneSize = MODULE.isV10 ? this.scene.grid.size : this.scene.data.grid;

    const destination = Crosshairs.getSnappedPosition(MODULE.isV10 ? this.document : this.data, this.interval);
    this.radius = document.distance * thisSceneSize;
    this.cancelled = false;

    if ( MODULE.isV10 ) this.document.updateSource({...destination});
    else this.data.update({destination});

    this.clearHandlers(event);
  }

  // Rotate the template by 3 degree increments (mouse-wheel)
  _mouseWheelHandler(event) {

    if ( event.ctrlKey ) event.preventDefault(); // Avoid zooming the browser window
    event.stopPropagation();

    let delta = canvas.grid.type > CONST.GRID_TYPES.SQUARE ? 30 : 15;
    let snap = event.shiftKey ? delta : 5;
    //BEGIN WARPGATE
    const document = MODULE.isV10 ? this.document : this.data;
    //const canvasSceneDistance = MODULE.isV10 ? canvas.scene.grid.distance : canvas.scene.data.gridDistance;
    //const thisSceneDistance = MODULE.isV10 ? this.scene.grid.distance : this.scene.data.gridDistance;
    const thisSceneSize = MODULE.isV10 ? this.scene.grid.size : this.scene.data.grid;
    if (event.shiftKey &amp;&amp; !this.lockSize) {
      let distance = document.distance + 0.25 * (Math.sign(event.deltaY));
      distance = Math.max(distance, 0.25);
      if ( MODULE.isV10 ) this.document.updateSource({distance});
      else this.data.update({distance});
      this.radius = document.distance * thisSceneSize;
    } else {
      const direction = document.direction + (snap * Math.sign(event.deltaY));
      if ( MODULE.isV10 ) this.document.updateSource({direction});
      else this.data.update({direction});
      logger.debug(`New Rotation: ${direction}`);
    }
    //END WARPGATE
    this.refresh();
  }

  _cancelHandler(event) {
    this.cancelled = true;
    this.clearHandlers(event);
  }

  _clearHandlers(event) {
    //WARPGATE BEGIN
    /* remove only ourselves, in case of multiple */
    this.layer.preview.removeChild(this);
    //WARPGATE END
    canvas.stage.off("mousemove", this.activeMoveHandler);
    canvas.stage.off("mousedown", this.activeLeftClickHandler);
    canvas.app.view.oncontextmenu = null;
    canvas.app.view.onwheel = null;

    /* moving off this layer also deletes ALL active previews?
     * unexpected, but manageable
     */
    if(this.layer.preview.children.length == 0){
      this.initialLayer.activate();
    }

    //BEGIN WARPGATE
    // Show the sheet that originated the preview
    if ( this.actorSheet ) this.actorSheet.maximize();
    this.activeHandlers = false;
    this.inFlight = false;

    /* mark this pixi element as destroyed */
    this._destroyed = true;
    //END WARPGATE
  }

  /**
   * Activate listeners for the template preview
   */
  activatePreviewListeners() {
    this.moveTime = 0;
    //BEGIN WARPGATE
    this.activeHandlers = true;

    /* Activate listeners */

    this.activeMoveHandler = this._mouseMoveHandler.bind(this);
    this.activeLeftClickHandler = this._leftClickHandler.bind(this);
    this.cancelHandler = this._cancelHandler.bind(this);
    this.activeWheelHandler = this._mouseWheelHandler.bind(this);

    this.clearHandlers = this._clearHandlers.bind(this);

    // Update placement (mouse-move)
    canvas.stage.on("mousemove", this.activeMoveHandler);

    // Confirm the workflow (left-click)
    canvas.stage.on("mousedown", this.activeLeftClickHandler);

    // Mouse Wheel rotate
    canvas.app.view.onwheel = this.activeWheelHandler;
    
    // Right click cancel
    canvas.app.view.oncontextmenu = this.cancelHandler;

    // END WARPGATE
  }

  /** END ABILITY-TEMPLATE.JS USAGE */
}
</code></pre>
        </article>
    </section>




    </div>

    <footer class="footer" id="footer">
      
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"Crosshairs","link":"<a href=\"Crosshairs.html\">Crosshairs</a>"},{"title":"Crosshairs.getTag","link":"<a href=\"Crosshairs.html#.getTag\">Crosshairs &rtrif; getTag</a>"},{"title":"Crosshairs#_drawControlIcon","link":"<a href=\"Crosshairs.html#_drawControlIcon\">Crosshairs &rtrif; _drawControlIcon</a>"},{"title":"Crosshairs#_drawRulerText","link":"<a href=\"Crosshairs.html#_drawRulerText\">Crosshairs &rtrif; _drawRulerText</a>"},{"title":"Crosshairs#activatePreviewListeners","link":"<a href=\"Crosshairs.html#activatePreviewListeners\">Crosshairs &rtrif; activatePreviewListeners</a>"},{"title":"Crosshairs#draw","link":"<a href=\"Crosshairs.html#draw\">Crosshairs &rtrif; draw</a>"},{"title":"Crosshairs#drawPreview","link":"<a href=\"Crosshairs.html#drawPreview\">Crosshairs &rtrif; drawPreview</a>"},{"title":"Crosshairs#refresh","link":"<a href=\"Crosshairs.html#refresh\">Crosshairs &rtrif; refresh</a>"},{"title":"Crosshairs#toObject","link":"<a href=\"Crosshairs.html#toObject\">Crosshairs &rtrif; toObject</a>"},{"title":"MutationStack","link":"<a href=\"MutationStack.html\">MutationStack</a>"},{"title":"MutationStack#commit","link":"<a href=\"MutationStack.html#commit\">MutationStack &rtrif; commit</a>"},{"title":"MutationStack#deleteAll","link":"<a href=\"MutationStack.html#deleteAll\">MutationStack &rtrif; deleteAll</a>"},{"title":"MutationStack#find","link":"<a href=\"MutationStack.html#find\">MutationStack &rtrif; find</a>"},{"title":"MutationStack#getName","link":"<a href=\"MutationStack.html#getName\">MutationStack &rtrif; getName</a>"},{"title":"MutationStack#update","link":"<a href=\"MutationStack.html#update\">MutationStack &rtrif; update</a>"},{"title":"MutationStack#updateAll","link":"<a href=\"MutationStack.html#updateAll\">MutationStack &rtrif; updateAll</a>"},{"title":"warpgate","link":"<a href=\"warpgate.html\">warpgate</a>"},{"title":"warpgate.buttonDialog","link":"<a href=\"warpgate.html#.buttonDialog\">warpgate &rtrif; buttonDialog</a>"},{"title":"warpgate.dismiss","link":"<a href=\"warpgate.html#.dismiss\">warpgate &rtrif; dismiss</a>"},{"title":"warpgate.menu","link":"<a href=\"warpgate.html#.menu\">warpgate &rtrif; menu</a>"},{"title":"warpgate.mutate","link":"<a href=\"warpgate.html#.mutate\">warpgate &rtrif; mutate</a>"},{"title":"warpgate.mutationStack","link":"<a href=\"warpgate.html#.mutationStack\">warpgate &rtrif; mutationStack</a>"},{"title":"warpgate.revert","link":"<a href=\"warpgate.html#.revert\">warpgate &rtrif; revert</a>"},{"title":"warpgate.spawn","link":"<a href=\"warpgate.html#.spawn\">warpgate &rtrif; spawn</a>"},{"title":"warpgate.spawnAt","link":"<a href=\"warpgate.html#.spawnAt\">warpgate &rtrif; spawnAt</a>"},{"title":"warpgate.wait","link":"<a href=\"warpgate.html#.wait\">warpgate &rtrif; wait</a>"},{"title":"abstract","link":"<a href=\"warpgate.abstract.html\">abstract</a>"},{"title":"crosshairs","link":"<a href=\"warpgate.crosshairs.html\">crosshairs</a>"},{"title":"warpgate.crosshairs.collectPlaceables","link":"<a href=\"warpgate.crosshairs.html#.collectPlaceables\">warpgate &rtrif; crosshairs</a>"},{"title":"warpgate.crosshairs.getTag","link":"<a href=\"warpgate.crosshairs.html#.getTag\">warpgate &rtrif; crosshairs</a>"},{"title":"warpgate.crosshairs.show","link":"<a href=\"warpgate.crosshairs.html#.show\">warpgate &rtrif; crosshairs</a>"},{"title":"dnd5e","link":"<a href=\"warpgate.dnd5e.html\">dnd5e</a>"},{"title":"warpgate.dnd5e.rollItem","link":"<a href=\"warpgate.dnd5e.html#.rollItem\">warpgate &rtrif; dnd5e</a>"},{"title":"event","link":"<a href=\"warpgate.event.html\">event</a>"},{"title":"warpgate.event.notify","link":"<a href=\"warpgate.event.html#.notify\">warpgate &rtrif; event</a>"},{"title":"warpgate.event.remove","link":"<a href=\"warpgate.event.html#.remove\">warpgate &rtrif; event</a>"},{"title":"warpgate.event.trigger","link":"<a href=\"warpgate.event.html#.trigger\">warpgate &rtrif; event</a>"},{"title":"warpgate.event.watch","link":"<a href=\"warpgate.event.html#.watch\">warpgate &rtrif; event</a>"},{"title":"plugin","link":"<a href=\"warpgate.plugin.html\">plugin</a>"},{"title":"warpgate.plugin.queueUpdate","link":"<a href=\"warpgate.plugin.html#.queueUpdate\">warpgate &rtrif; plugin</a>"},{"title":"util","link":"<a href=\"warpgate.util.html\">util</a>"},{"title":"warpgate.util.firstGM","link":"<a href=\"warpgate.util.html#.firstGM\">warpgate &rtrif; util</a>"},{"title":"warpgate.util.firstOwner","link":"<a href=\"warpgate.util.html#.firstOwner\">warpgate &rtrif; util</a>"},{"title":"warpgate.util.isFirstGM","link":"<a href=\"warpgate.util.html#.isFirstGM\">warpgate &rtrif; util</a>"},{"title":"warpgate.util.isFirstOwner","link":"<a href=\"warpgate.util.html#.isFirstOwner\">warpgate &rtrif; util</a>"},{"title":"ComparisonKeys","link":"<a href=\"global.html#ComparisonKeys\">ComparisonKeys</a>"},{"title":"CrosshairsConfig","link":"<a href=\"global.html#CrosshairsConfig\">CrosshairsConfig</a>"},{"title":"CrosshairsData","link":"<a href=\"global.html#CrosshairsData\">CrosshairsData</a>"},{"title":"MutationData","link":"<a href=\"global.html#MutationData\">MutationData</a>"},{"title":"MutationOptions","link":"<a href=\"global.html#MutationOptions\">MutationOptions</a>"},{"title":"ParallelShow","link":"<a href=\"global.html#ParallelShow\">ParallelShow</a>"},{"title":"PostDelta","link":"<a href=\"global.html#PostDelta\">PostDelta</a>"},{"title":"PostMutate","link":"<a href=\"global.html#PostMutate\">PostMutate</a>"},{"title":"PostSpawn","link":"<a href=\"global.html#PostSpawn\">PostSpawn</a>"},{"title":"PreSpawn","link":"<a href=\"global.html#PreSpawn\">PreSpawn</a>"},{"title":"Shorthand","link":"<a href=\"global.html#Shorthand\">Shorthand</a>"},{"title":"SpawningOptions","link":"<a href=\"global.html#SpawningOptions\">SpawningOptions</a>"},{"title":"WarpOptions","link":"<a href=\"global.html#WarpOptions\">WarpOptions</a>"},{"title":"WorkflowOptions","link":"<a href=\"global.html#WorkflowOptions\">WorkflowOptions</a>"}];
        var options = 
          setupSearch(list, options)
      </script>
    

    

    

    


  </body>

</html>
